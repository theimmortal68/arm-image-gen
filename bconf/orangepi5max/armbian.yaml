---
mmdebstrap:
  packages:
    - linux-image-current-rockchip-rk3588
    - linux-dtb-current-rockchip-rk3588
    - linux-u-boot-orangepi5-max-current
    - armbian-bsp-cli-orangepi5-max-current
    - armbian-firmware
    - u-boot-tools
    - parted

  customize-hooks:
    - |
      set -euo pipefail
      export DEBIAN_FRONTEND=noninteractive

      printf "orangepi5max\n" > "$1/etc/device-id"
      install -d "$1/usr/share/keyrings" "$1/etc/apt/sources.list.d" "$1/etc/apt/preferences.d" "$1/boot"

      # Armbian repo + key
      wget -qO- https://apt.armbian.com/armbian.key | gpg --dearmor > "$1/usr/share/keyrings/armbian.gpg"
      chmod 0644 "$1/usr/share/keyrings/armbian.gpg"

      cat >"$1/etc/apt/sources.list.d/armbian.list" <<'EOF'
      deb [signed-by=/usr/share/keyrings/armbian.gpg] http://apt.armbian.com bookworm main bookworm-utils bookworm-desktop
      EOF

      # Pin Armbian kernel/uboot/bsp HIGH so Debian can't override
      cat >"$1/etc/apt/preferences.d/99-armbian-kernel.pref" <<'EOF'
      Package: linux-image-*-rockchip-rk3588 linux-dtb-*-rockchip-rk3588 linux-u-boot-orangepi5-max-* armbian-bsp-cli-orangepi5-max-* armbian-firmware
      Pin: origin apt.armbian.com
      Pin-Priority: 1001
      EOF

      chroot "$1" bash -euo pipefail <<'EOSH'
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get install -y \
        linux-image-current-rockchip-rk3588 \
        linux-dtb-current-rockchip-rk3588 \
        linux-u-boot-orangepi5-max-current \
        armbian-bsp-cli-orangepi5-max-current \
        armbian-firmware \
        u-boot-tools \
        parted
      EOSH
