---
mmdebstrap:
  customize-hooks:
    - |
      set -eu
      install -d "$1/usr/share/keyrings" "$1/etc/apt/sources.list.d"
      # Install Armbian repo key into a dedicated keyring
      curl -fsSL https://apt.armbian.com/armbian.key \
        | gpg --dearmor -o "$1/usr/share/keyrings/armbian.gpg"
      chmod 0644 "$1/usr/share/keyrings/armbian.gpg"

      # Armbian repo on Bookworm (components include main + bookworm-utils + bookworm-desktop)
      cat > "$1/etc/apt/sources.list.d/armbian.list" <<'EOF'
      deb [signed-by=/usr/share/keyrings/armbian.gpg] http://apt.armbian.com bookworm main bookworm-utils bookworm-desktop
      EOF

      # Optional: pull firmware/meta from Armbian
      chroot "$1" bash -euo pipefail <<'EOSH'
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get install -y armbian-firmware || true
      EOSH

      chroot "$1" bash -euo pipefail <<'EOSH'
      set -eux
      export DEBIAN_FRONTEND=noninteractive
      CS_VER="${CAMERA_STREAMER_VERSION:-0.2.8}"
      ARCH="$(dpkg --print-architecture)"
      CODENAME="$(. /etc/os-release; echo "${VERSION_CODENAME}")"
      BASE="https://github.com/ayufan/camera-streamer/releases/download/v${CS_VER}"
      for PKG in \
        "camera-streamer-generic_${CS_VER}.${CODENAME}_${ARCH}.deb" \
        "camera-streamer-rk3588_${CS_VER}.${CODENAME}_${ARCH}.deb" \
        "camera-streamer-rk3399_${CS_VER}.${CODENAME}_${ARCH}.deb"
      do
        if curl -fsSLo "/tmp/$PKG" "${BASE}/${PKG}"; then
          apt-get -y install "/tmp/$PKG" && break
        fi
      done
      EOSH
