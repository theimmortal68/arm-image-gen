---
name: base-packages-debian
mmdebstrap:
  suite: bookworm
  components:
    - main
    - contrib
    - non-free
    - non-free-firmware
  architectures:
    - arm64
  variant: apt
  format: directory

  # Runs before aptâ€™s first transactions: block service starts, seed Debian keyring.
  setup-hooks:
    - |
      set -eu
      install -d "$1/usr/sbin" "$1/usr/share/keyrings" "$1/etc/apt/trusted.gpg.d"

      # Block services inside chroot (CustoPiZer will re-enable later)
      cat > "$1/usr/sbin/policy-rc.d" <<'EOS'
      #!/bin/sh
      exit 101
      EOS
      chmod +x "$1/usr/sbin/policy-rc.d"

      # Seed Debian archive key so apt can verify Release files during bootstrap
      if [ -s /usr/share/keyrings/debian-archive-keyring.gpg ]; then
        cp -a /usr/share/keyrings/debian-archive-keyring.gpg "$1/usr/share/keyrings/"
      else
        tmpdir="$(mktemp -d)"; trap 'rm -rf "$tmpdir"' EXIT
        curl -fsSL https://ftp-master.debian.org/keys/archive-key-12.asc \
          -o "$tmpdir/archive-key-12.asc"
        curl -fsSL https://ftp-master.debian.org/keys/archive-key-12-security.asc \
          -o "$tmpdir/archive-key-12-security.asc"
        cat "$tmpdir"/archive-key-12*.asc | gpg --dearmor > \
          "$1/usr/share/keyrings/debian-archive-keyring.gpg"
      fi
      chmod 0644 "$1/usr/share/keyrings/debian-archive-keyring.gpg"

      # Also place into trusted.gpg.d so apt trusts it immediately (no signed-by needed)
      cp -a "$1/usr/share/keyrings/debian-archive-keyring.gpg" \
            "$1/etc/apt/trusted.gpg.d/debian-archive-keyring.gpg" || true

  # Small apt hardening for CI networks.
  customize-hooks:
    - |
      set -eu
      install -d "$1/etc/apt/apt.conf.d"
      cat > "$1/etc/apt/apt.conf.d/99net-tuning" <<'EOF'
      Acquire::ForceIPv4 "true";
      Acquire::Retries "5";
      Acquire::http::Timeout "30";
      Acquire::https::Timeout "30";
      Acquire::Languages "none";
      EOF
