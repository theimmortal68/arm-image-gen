---
mmdebstrap:
  suite: noble            # or jammy
  architectures:
    - arm64
  components:
    - main
    - restricted
    - universe
    - multiverse
  variant: apt
  format: directory
  # Let mmdebstrap trust Ubuntuâ€™s archive during bootstrap
  keyrings:
    - /usr/share/keyrings/ubuntu-archive-keyring.gpg
  mirrors:
    - http://ports.ubuntu.com/ubuntu-ports

  setup-hooks:
    - |
      set -e
      # Block service auto-start inside chroot
      install -d "$1/usr/sbin"
      cat > "$1/usr/sbin/policy-rc.d" <<'EOS'
      #!/bin/sh
      exit 101
      EOS
      chmod +x "$1/usr/sbin/policy-rc.d"

  customize-hooks:
    - |
      set -e
      # Use deb822-style source with Signed-By (Ubuntu 22.04+)
      install -d "$1/etc/apt/sources.list.d"
      cat >"$1/etc/apt/sources.list.d/ubuntu.sources" <<'EOF'
      Types: deb
      URIs: http://ports.ubuntu.com/ubuntu-ports
      Suites: noble noble-updates noble-security noble-backports
      Components: main restricted universe multiverse
      Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg
      EOF

      # Make apt more resilient in CI
      cat > "$1/etc/apt/apt.conf.d/99net-tuning" <<'EOF'
      Acquire::ForceIPv4 "true";
      Acquire::Retries "5";
      Acquire::http::Timeout "30";
      Acquire::https::Timeout "30";
      EOF

  packages:
    - ca-certificates
    - curl
    - wget
    - git
    - unzip
    - rsync
    - jq
    - crudini
    - python3
    - python3-venv
    - python3-dev
    - python3-pip
    - build-essential
    - gcc
    - g++
    - make
    - pkg-config
    - libffi-dev
    - libusb-1.0-0-dev
    - libncurses-dev
