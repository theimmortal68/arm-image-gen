---
name: rpi-firmware
mmdebstrap:
  packages:
    - raspi-firmware

  customize-hooks:
    - |
      set -eu
      TARGET="$1"
      # Where the source files live on the HOST (not in the target rootfs):
      SRC="${BOOT_FIRMWARE_DIR:-$PWD/bconf/rpi64/boot-firmware}"

      # Sanity check
      [ -r "$SRC/cmdline.txt" ] && [ -r "$SRC/config.txt" ] || {
        echo "Missing cmdline.txt or config.txt in $SRC" >&2; exit 1; }

      # Ensure /boot layout in target
      install -d "$TARGET/boot/firmware"
      ln -sf firmware/overlays "$TARGET/boot/overlays"

      # Copy the files into the target
      install -m 0644 "$SRC/cmdline.txt" "$TARGET/boot/firmware/"
      install -m 0644 "$SRC/config.txt"  "$TARGET/boot/firmware/"

      # Drop redirection stubs in /boot (human-friendly)
      for f in cmdline.txt config.txt; do
        printf "DO NOT EDIT THIS FILE\n\nThe file you are looking for has moved to %s\n" "/boot/firmware/$f" \
          > "$TARGET/boot/$f"
      done
