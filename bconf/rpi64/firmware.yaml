
---
mmdebstrap:
  packages:
    - firmware-brcm80211

hooks:
  chroot: |
    set -euo pipefail
    export DEBIAN_FRONTEND=noninteractive

    printf "rpi64\n" > /etc/device-id
    install -d /usr/share/keyrings /etc/apt/sources.list.d /etc/apt/preferences.d /boot/firmware

    curl -fsSL https://archive.raspberrypi.com/debian/raspberrypi.gpg.key       | gpg --dearmor -o /usr/share/keyrings/raspberrypi-archive-keyring.gpg
    chmod 0644 /usr/share/keyrings/raspberrypi-archive-keyring.gpg

    cat >/etc/apt/sources.list.d/raspi.list <<'EOF'
    deb [signed-by=/usr/share/keyrings/raspberrypi-archive-keyring.gpg] http://archive.raspberrypi.com/debian bookworm main
    EOF

    cat >/etc/apt/preferences.d/99-raspberrypi-kernel.pref <<'EOF'
    Package: raspberrypi-kernel raspberrypi-bootloader rpi-eeprom
    Pin: origin archive.raspberrypi.com
    Pin-Priority: 1001
    EOF

    cat >/etc/apt/preferences.d/10-avoid-debian-kernel.pref <<'EOF'
    Package: linux-image-arm64
    Pin: release o=Debian
    Pin-Priority: -1
    EOF

    apt-get update
    apt-get install -y raspberrypi-kernel raspberrypi-bootloader rpi-eeprom

    cat >/boot/firmware/config.txt <<'EOF'
    arm_64bit=1
    enable_uart=1
    hdmi_force_hotplug=1
    dtoverlay=vc4-kms-v3d
    EOF

    cat >/boot/firmware/cmdline.txt <<'EOF'
    console=serial0,115200 console=tty1 root=PARTUUID=00000000-02 rootfstype=ext4 fsck.repair=yes rootwait
    EOF
