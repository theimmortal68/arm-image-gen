---
mmdebstrap:
  # Add Raspberry Pi archive, pin kernel/bootloader high, install firmware/kernel/EEPROM
  customize-hooks:
    - |
      set -eu
      export DEBIAN_FRONTEND=noninteractive

      printf "rpi64\n" > "$1/etc/device-id"
      install -d "$1/usr/share/keyrings" "$1/etc/apt/sources.list.d" "$1/etc/apt/preferences.d" "$1/boot/firmware"

      # Raspberry Pi repo + key (bookworm)
      curl -fsSL https://archive.raspberrypi.com/debian/raspberrypi.gpg.key       | gpg --dearmor -o "$1/usr/share/keyrings/raspberrypi-archive-keyring.gpg"
      chmod 0644 "$1/usr/share/keyrings/raspberrypi-archive-keyring.gpg"

      cat >"$1/etc/apt/sources.list.d/raspi.list" <<'EOF'
      deb [signed-by=/usr/share/keyrings/raspberrypi-archive-keyring.gpg] http://archive.raspberrypi.com/debian bookworm main
      EOF

      # Pin Raspberry Pi kernel/bootloader/EEPROM HIGH so Debian can't override
      cat >"$1/etc/apt/preferences.d/99-raspberrypi-kernel.pref" <<'EOF'
      Package: raspberrypi-kernel raspberrypi-bootloader rpi-eeprom
      Pin: origin archive.raspberrypi.com
      Pin-Priority: 1001
      EOF

      # Avoid Debian's generic kernel replacing RPi's packages accidentally
      cat >"$1/etc/apt/preferences.d/10-avoid-debian-kernel.pref" <<'EOF'
      Package: linux-image-arm64
      Pin: release o=Debian
      Pin-Priority: -1
      EOF

      chroot "$1" bash -euo pipefail <<'EOSH'
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get install -y raspberrypi-kernel raspberrypi-bootloader rpi-eeprom
      EOSH

      # Provide safe defaults for boot (Pi packages also manage /boot content)
      cat >"$1/boot/firmware/config.txt" <<'EOF'
      arm_64bit=1
      enable_uart=1
      hdmi_force_hotplug=1
      dtoverlay=vc4-kms-v3d
      EOF

      cat >"$1/boot/firmware/cmdline.txt" <<'EOF'
      console=serial0,115200 console=tty1 root=PARTUUID=00000000-02 rootfstype=ext4 fsck.repair=yes rootwait
      EOF
