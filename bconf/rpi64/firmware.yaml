# bconf/rpi64/firmware.yaml
# Enable the Raspberry Pi archive during mmdebstrap *setup* so it is present
# before any package resolution. Install the official archive keyring .deb
# into the TARGET rootfs, add APT pins for userland/camera and kernel, and
# write safe boot defaults.
---
mmdebstrap:
  setup-hooks:
    - |
      set -eu
      export DEBIAN_FRONTEND=noninteractive
      install -d "$1/usr/share/keyrings" "$1/etc/apt/sources.list.d" "$1/etc/apt/preferences.d" "$1/boot/firmware" "$1/tmp"

      # --------------------------------------------------------------------
      # Install the official Raspberry Pi archive keyring via .deb (in target)
      # --------------------------------------------------------------------
      BASE="https://archive.raspberrypi.com/debian/pool/main/r/raspberrypi-archive-keyring"
      # Find latest keyring .deb from directory listing, download into target, dpkg -i inside chroot
      DEB="$(curl -fsSL "${BASE}/" \
            | sed -n 's@.*href="\([^"]*raspberrypi-archive-keyring_[^"]*_all\.deb\)".*@\1@p' \
            | sort -V | tail -1)"
      if [ -z "${DEB:-}" ]; then
        echo "ERROR: could not determine raspberrypi-archive-keyring .deb" >&2
        exit 1
      fi
      curl -fsSL -o "$1/tmp/${DEB##*/}" "${BASE}/${DEB##*/}"
      chroot "$1" dpkg -i "/tmp/${DEB##*/}"
      rm -f "$1/tmp/${DEB##*/}"

      # Raspberry Pi archive (Bookworm) â€” use HTTPS and Signed-By
      cat >"$1/etc/apt/sources.list.d/raspi.list" <<'EOF'
      deb [signed-by=/usr/share/keyrings/raspberrypi-archive-keyring.gpg] https://archive.raspberrypi.com/debian bookworm main
      EOF

      # --------------------------------------------------------------------
      # APT pins
      # --------------------------------------------------------------------

      # Prefer Pi-origin userland & camera stack (lets rpicam-apps pull correct libcamera*)
      cat >"$1/etc/apt/preferences.d/50-raspi-userland.pref" <<'EOF'
      Explanation: Prefer Raspberry Pi userland & camera stack
      Package: libraspberrypi* rpicam* raspi* raspberrypi-* libcamera* gstreamer1.0-libcamera*
      Pin: origin "archive.raspberrypi.com"
      Pin-Priority: 1001
      EOF

      # Pin Raspberry Pi kernel/bootloader/EEPROM so Debian can't override
      cat >"$1/etc/apt/preferences.d/60-raspi-kernel.pref" <<'EOF'
      Explanation: Prefer Raspberry Pi kernel/bootloader/EEPROM from Raspberry Pi archive
      Package: raspberrypi-kernel raspberrypi-bootloader rpi-eeprom
      Pin: origin "archive.raspberrypi.com"
      Pin-Priority: 1001
      EOF

      # Avoid Debian's generic kernel replacing Raspberry Pi's packages accidentally
      cat >"$1/etc/apt/preferences.d/10-avoid-debian-kernel.pref" <<'EOF'
      Package: linux-image-arm64
      Pin: release o=Debian
      Pin-Priority: -1
      EOF

      # --------------------------------------------------------------------
      # Boot defaults (Pi packages also manage /boot content)
      # --------------------------------------------------------------------
      cat >"$1/boot/firmware/config.txt" <<'EOF'
      arm_64bit=1
      enable_uart=1
      hdmi_force_hotplug=1
      dtoverlay=vc4-kms-v3d
      EOF

      cat >"$1/boot/firmware/cmdline.txt" <<'EOF'
      console=serial0,115200 console=tty1 root=LABEL=rootfs rootfstype=ext4 fsck.repair=yes rootwait
      EOF

  # Install these from the Pi archive (repo is active thanks to setup-hooks above)
  packages:
    - raspberrypi-kernel
    - raspberrypi-bootloader
    - rpi-eeprom
