---
name: rpi-bookworm-apt
mmdebstrap:
  # …your other mmdebstrap settings…
  essential-hooks:
    - |
      set -eu
      TARGET="$1"
      install -d \
        "$TARGET/usr/share/keyrings" \
        "$TARGET/etc/apt/sources.list.d" \
        "$TARGET/etc/apt/preferences.d"

      # Use ONE host consistently (.com or .org)
      RPI_HOST="archive.raspberrypi.com"
      # RPI_HOST="archive.raspberrypi.org"

      # Import Raspberry Pi APT key
      curl -fsSL "https://${RPI_HOST}/debian/raspberrypi.gpg.key" \
        | gpg --dearmor > "$TARGET/usr/share/keyrings/raspberrypi-archive-keyring.gpg"
      chmod 0644 "$TARGET/usr/share/keyrings/raspberrypi-archive-keyring.gpg"

      # Add Raspberry Pi repo (Bookworm)
      cat >"$TARGET/etc/apt/sources.list.d/raspi.list" <<EOF
      deb [arch=arm64 signed-by=/usr/share/keyrings/raspberrypi-archive-keyring.gpg] https://${RPI_HOST}/debian bookworm main
      EOF
      
      # Make the new repo visible for the next stage
      chroot "$TARGET" apt-get update
  customize-hooks:
    - |
      set -eu
      export DEBIAN_FRONTEND=noninteractive

      printf "rpi64\n" > "$1/etc/device-id"
      install -d "$1/usr/share/keyrings" "$1/etc/apt/sources.list.d" "$1/etc/apt/preferences.d" "$1/boot/firmware"

      # --------------------------------------------------------------------
      # APT pins
      # --------------------------------------------------------------------

      # Prefer Pi-origin userland & camera stack (lets rpicam-apps pull correct libcamera*)
      cat >"$1/etc/apt/preferences.d/50-raspi-userland.pref" <<'EOF'
      Explanation: Prefer Raspberry Pi userland & camera stack
      Package: libraspberrypi* rpicam* raspi* raspberrypi-* libcamera* gstreamer1.0-libcamera*
      Pin: origin "archive.raspberrypi.com"
      Pin-Priority: 1001
      EOF

      # Pin Raspberry Pi kernel/bootloader/EEPROM so Debian can't override
      cat >"$1/etc/apt/preferences.d/60-raspi-kernel.pref" <<'EOF'
      Explanation: Prefer Raspberry Pi kernel/bootloader/EEPROM from Raspberry Pi archive
      Package: linux-image-rpi-2712 rpi-eeprom
      Pin: origin "archive.raspberrypi.com"
      Pin-Priority: 1001
      EOF

      # Avoid Debian's generic kernel replacing Raspberry Pi's packages accidentally
      cat >"$1/etc/apt/preferences.d/10-avoid-debian-kernel.pref" <<'EOF'
      Package: linux-image-arm64
      Pin: release o=Debian
      Pin-Priority: -1
      EOF
